#!/usr/bin/env php
<?php
require_once dirname(__DIR__) . '/common.php';

$storage = $argv[1] ?: 'redis';

while (1) {
    sendRequest($storage);
}

function sendRequest($storage)
{
    $ganesha = buildGanesha($storage);
    $client = new GuzzleHttp\Client();
    if ($ganesha->isAvailable(RESOURCE)) {
        try {
            $serverHost = getenv('GANESHA_EXAMPLE_SERVER') ?: 'localhost';
            $client->request('GET', "http://{$serverHost}/server/index.php");
        } catch (\Exception $e) {
            echo  date('H:i:s') . " <failure>\n";
            $ganesha->failure(RESOURCE);
            return;
        }

        $ganesha->success(RESOURCE);
        echo date('H:i:s') . " (success)\n";
    } else {
        echo date('H:i:s') . " [[[ reject ]]]\n";
    }
}
